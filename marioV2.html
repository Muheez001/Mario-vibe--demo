<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mario Platformer Game</title>
  <style>
    body { margin:0; padding:20px; background:linear-gradient(to bottom,#87CEEB,#98FB98); font-family:Arial,sans-serif; display:flex; flex-direction:column; align-items:center; }
    #gameContainer { border:3px solid #8B4513; border-radius:10px; overflow:hidden; box-shadow:0 0 20px rgba(0,0,0,0.5); position:relative; }
    canvas { display:block; background:linear-gradient(to bottom,#87CEEB 0%,#87CEEB 60%,#90EE90 60%,#228B22 100%); }
    #controls { margin-top:20px; text-align:center; background:rgba(255,255,255,0.9); padding:15px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2); }
    #score { font-size:24px; font-weight:bold; margin-bottom:20px; color:#333; }
    .game-over,.game-win { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); color:#fff; padding:30px; border-radius:15px; text-align:center; font-size:24px; z-index:1000; }
    button { background:#FF6B35; color:#fff; border:none; padding:10px 20px; border-radius:5px; font-size:16px; cursor:pointer; margin-top:15px; }
    button:hover { background:#E55A2B; }
  </style>
</head>
<body>
  <div id="score">Score: 0</div>
  <div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="400"></canvas>
  </div>

  <div id="controls">
    <p><strong>Controls:</strong></p>
    <p>Move: WASD or Arrow Keys | Jump: Space Bar</p>
    <p>Complete all 3 levels to win the game!</p>
    <p><em>Click anywhere or press any key to start background music</em></p>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score');

    // ---------------- AUDIO MANAGER ----------------
    let musicStarted = false;
    const AudioMgr = {
      ctx: null,
      bg: { osc1:null, osc2:null, gain:null, timerId:null, playing:false },
      init() {
        if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      },
      startBg() {
        this.init();
        this.stopBg();

        const { ctx } = this;
        const osc1 = ctx.createOscillator();
        const osc2 = ctx.createOscillator();
        const gain = ctx.createGain();

        osc1.type = 'square';
        osc2.type = 'square';
        gain.gain.value = 0.08;

        osc1.connect(gain);
        osc2.connect(gain);
        gain.connect(ctx.destination);

        osc1.start();
        osc2.start();

        const notes = [262, 294, 330, 349, 392, 440, 494, 523]; // C major
        let i = 0;
        const tick = () => {
          if (!this.bg.playing) return;
          // keep in sync with the single context clock
          osc1.frequency.setValueAtTime(notes[i % notes.length], ctx.currentTime);
          osc2.frequency.setValueAtTime(notes[(i + 2) % notes.length], ctx.currentTime);
          i++;
          this.bg.timerId = setTimeout(tick, 500);
        };

        this.bg = { osc1, osc2, gain, timerId:null, playing:true };
        tick();
      },
      stopBg() {
        if (this.bg.timerId) { clearTimeout(this.bg.timerId); this.bg.timerId = null; }
        if (this.bg.osc1) { try { this.bg.osc1.stop(); } catch(e) {} this.bg.osc1.disconnect(); }
        if (this.bg.osc2) { try { this.bg.osc2.stop(); } catch(e) {} this.bg.osc2.disconnect(); }
        if (this.bg.gain) { try { this.bg.gain.disconnect(); } catch(e) {} }
        this.bg = { osc1:null, osc2:null, gain:null, timerId:null, playing:false };
      },
      playCelebration() {
        this.init();
        const ctx = this.ctx;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'square';
        osc.connect(gain);
        gain.connect(ctx.destination);

        const notes = [262, 330, 392, 523, 659, 784, 1047];
        let idx = 0;

        const step = () => {
          if (idx >= notes.length) return;
          osc.frequency.setValueAtTime(notes[idx], ctx.currentTime);
          gain.gain.setValueAtTime(0.25, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
          idx++;
          setTimeout(step, 150);
        };

        osc.start();
        step();
        setTimeout(() => { try { osc.stop(); } catch(e) {} try { gain.disconnect(); } catch(e) {} }, 2000);
      },
      stopAll() {
        this.stopBg();
        // Celebration tones are short and self stopping, no persistent reference needed
      }
    };

    function initAudio() {
      if (!musicStarted) {
        AudioMgr.startBg();
        musicStarted = true;
      }
    }

    // --------------- GAME STATE ----------------
    let score = 0;
    let gameRunning = true;
    let camera = { x: 0, y: 0 };
    let currentLevel = 1;
    let totalLevels = 3;
    let levelComplete = false;
    let celebrationTimer = 0;

    const player = {
      x: 50, y: 300, width: 30, height: 30,
      velocityX: 0, velocityY: 0,
      speed: 5, jumpPower: 15,
      onGround: false, color: '#FF0000'
    };

    const keys = {};
    window.addEventListener('keydown', (e) => {
      keys[e.key.toLowerCase()] = true;
      if (e.key === ' ') e.preventDefault();
      if (!musicStarted) initAudio();
    });
    window.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });
    canvas.addEventListener('click', () => { if (!musicStarted) initAudio(); });

    let platforms = [];
    let enemies = [];
    let coins = [];
    let questionBlocks = [];
    let goal = {};
    const spawnedCoins = [];

    // --------------- LEVELS ----------------
    const levels = {
      1: {
        platforms: [
          { x:0, y:370, width:200, height:30, color:'#8B4513' },
          { x:250, y:370, width:150, height:30, color:'#8B4513' },
          { x:450, y:370, width:200, height:30, color:'#8B4513' },
          { x:700, y:370, width:150, height:30, color:'#8B4513' },
          { x:900, y:370, width:200, height:30, color:'#8B4513' },
          { x:1150, y:370, width:150, height:30, color:'#8B4513' },
          { x:1350, y:370, width:200, height:30, color:'#8B4513' },
          { x:300, y:280, width:100, height:20, color:'#228B22' },
          { x:500, y:250, width:80, height:20, color:'#228B22' },
          { x:750, y:280, width:120, height:20, color:'#228B22' },
          { x:950, y:220, width:100, height:20, color:'#228B22' },
          { x:1200, y:280, width:80, height:20, color:'#228B22' },
          { x:1400, y:250, width:100, height:20, color:'#228B22' }
        ],
        enemies: [
          { x:280, y:340, width:25, height:25, velocityX:2, color:'#8B0000', patrolStart:250, patrolEnd:400 },
          { x:480, y:340, width:25, height:25, velocityX:-1.5, color:'#8B0000', patrolStart:450, patrolEnd:600 },
          { x:780, y:340, width:25, height:25, velocityX:2.5, color:'#8B0000', patrolStart:700, patrolEnd:850 }
        ],
        coins: [
          { x:330, y:250, width:15, height:15, collected:false },
          { x:520, y:220, width:15, height:15, collected:false },
          { x:780, y:250, width:15, height:15, collected:false }
        ],
        questionBlocks: [
          { x:200, y:320, width:30, height:30, active:true, bounceOffset:0 },
          { x:350, y:240, width:30, height:30, active:true, bounceOffset:0 },
          { x:800, y:240, width:30, height:30, active:true, bounceOffset:0 }
        ],
        goal: { x:1500, y:250, width:20, height:120, color:'#FFD700' }
      },
      2: {
        platforms: [
          { x:0, y:370, width:150, height:30, color:'#8B4513' },
          { x:250, y:370, width:100, height:30, color:'#8B4513' },
          { x:450, y:300, width:120, height:20, color:'#228B22' },
          { x:650, y:370, width:100, height:30, color:'#8B4513' },
          { x:850, y:280, width:150, height:20, color:'#228B22' },
          { x:1100, y:370, width:120, height:30, color:'#8B4513' },
          { x:1300, y:200, width:100, height:20, color:'#228B22' },
          { x:1500, y:370, width:200, height:30, color:'#8B4513' },
          { x:180, y:280, width:80, height:20, color:'#228B22' },
          { x:380, y:220, width:60, height:20, color:'#228B22' },
          { x:750, y:250, width:80, height:20, color:'#228B22' },
          { x:1050, y:180, width:100, height:20, color:'#228B22' }
        ],
        enemies: [
          { x:280, y:340, width:25, height:25, velocityX:3, color:'#8B0000', patrolStart:250, patrolEnd:350 },
          { x:480, y:270, width:25, height:25, velocityX:-2, color:'#8B0000', patrolStart:450, patrolEnd:570 },
          { x:680, y:340, width:25, height:25, velocityX:2, color:'#8B0000', patrolStart:650, patrolEnd:750 },
          { x:880, y:250, width:25, height:25, velocityX:-2.5, color:'#8B0000', patrolStart:850, patrolEnd:1000 },
          { x:1130, y:340, width:25, height:25, velocityX:1.5, color:'#8B0000', patrolStart:1100, patrolEnd:1220 }
        ],
        coins: [
          { x:200, y:250, width:15, height:15, collected:false },
          { x:400, y:190, width:15, height:15, collected:false },
          { x:770, y:220, width:15, height:15, collected:false },
          { x:1070, y:150, width:15, height:15, collected:false },
          { x:1320, y:170, width:15, height:15, collected:false }
        ],
        questionBlocks: [
          { x:120, y:320, width:30, height:30, active:true, bounceOffset:0 },
          { x:320, y:260, width:30, height:30, active:true, bounceOffset:0 },
          { x:580, y:320, width:30, height:30, active:true, bounceOffset:0 },
          { x:920, y:240, width:30, height:30, active:true, bounceOffset:0 }
        ],
        goal: { x:1650, y:250, width:20, height:120, color:'#FFD700' }
      },
      3: {
        platforms: [
          { x:0, y:370, width:120, height:30, color:'#8B4513' },
          { x:200, y:300, width:80, height:20, color:'#228B22' },
          { x:350, y:250, width:100, height:20, color:'#228B22' },
          { x:520, y:200, width:80, height:20, color:'#228B22' },
          { x:680, y:280, width:120, height:20, color:'#228B22' },
          { x:880, y:180, width:100, height:20, color:'#228B22' },
          { x:1050, y:240, width:80, height:20, color:'#228B22' },
          { x:1200, y:160, width:120, height:20, color:'#228B22' },
          { x:1400, y:300, width:100, height:20, color:'#228B22' },
          { x:1580, y:370, width:200, height:30, color:'#8B4513' },
          { x:150, y:220, width:60, height:20, color:'#FF6347' },
          { x:290, y:180, width:60, height:20, color:'#FF6347' },
          { x:450, y:140, width:60, height:20, color:'#FF6347' }
        ],
        enemies: [
          { x:230, y:270, width:25, height:25, velocityX:2.5, color:'#8B0000', patrolStart:200, patrolEnd:280 },
          { x:380, y:220, width:25, height:25, velocityX:-3, color:'#8B0000', patrolStart:350, patrolEnd:450 },
          { x:550, y:170, width:25, height:25, velocityX:2, color:'#8B0000', patrolStart:520, patrolEnd:600 },
          { x:710, y:250, width:25, height:25, velocityX:-2.5, color:'#8B0000', patrolStart:680, patrolEnd:800 },
          { x:910, y:150, width:25, height:25, velocityX:3, color:'#8B0000', patrolStart:880, patrolEnd:980 },
          { x:1080, y:210, width:25, height:25, velocityX:-2, color:'#8B0000', patrolStart:1050, patrolEnd:1130 }
        ],
        coins: [
          { x:170, y:190, width:15, height:15, collected:false },
          { x:310, y:150, width:15, height:15, collected:false },
          { x:470, y:110, width:15, height:15, collected:false },
          { x:540, y:170, width:15, height:15, collected:false },
          { x:730, y:220, width:15, height:15, collected:false },
          { x:930, y:120, width:15, height:15, collected:false }
        ],
        questionBlocks: [
          { x:80, y:320, width:30, height:30, active:true, bounceOffset:0 },
          { x:250, y:260, width:30, height:30, active:true, bounceOffset:0 },
          { x:400, y:210, width:30, height:30, active:true, bounceOffset:0 },
          { x:650, y:240, width:30, height:30, active:true, bounceOffset:0 },
          { x:1000, y:140, width:30, height:30, active:true, bounceOffset:0 }
        ],
        goal: { x:1750, y:250, width:20, height:120, color:'#FFD700' }
      }
    };

    function loadLevel(levelNum) {
      const level = levels[levelNum];
      if (!level) return false;

      platforms = [...level.platforms];
      enemies = level.enemies.map(e => ({...e}));
      coins = level.coins.map(c => ({...c}));
      questionBlocks = level.questionBlocks.map(b => ({...b}));
      goal = {...level.goal};

      player.x = 50; player.y = 300;
      player.velocityX = 0; player.velocityY = 0; player.onGround = false;

      camera.x = 0; camera.y = 0;
      spawnedCoins.length = 0;
      return true;
    }

    // --------------- DRAWING ----------------
    function drawMario(x, y) {
      const p = 2;
      ctx.fillStyle = '#DC143C'; ctx.fillRect(x+4*p, y+2*p, 8*p, 4*p); // hat
      ctx.fillStyle = '#8B4513'; ctx.fillRect(x+2*p, y+6*p, 4*p, 2*p); ctx.fillRect(x+10*p, y+6*p, 4*p, 2*p); // hair
      ctx.fillStyle = '#FDBCB4'; ctx.fillRect(x+4*p, y+6*p, 6*p, 6*p); // face
      ctx.fillStyle = '#000'; ctx.fillRect(x+5*p, y+8*p, p, p); ctx.fillRect(x+8*p, y+8*p, p, p); // eyes
      ctx.fillStyle = '#DC143C'; ctx.fillRect(x+7*p, y+9*p, p, p); // nose
      ctx.fillStyle = '#8B4513'; ctx.fillRect(x+5*p, y+10*p, 4*p, p); // mustache
      ctx.fillStyle = '#DC143C'; ctx.fillRect(x+3*p, y+12*p, 8*p, 6*p); // shirt
      ctx.fillStyle = '#00F'; ctx.fillRect(x+4*p, y+18*p, 6*p, 6*p); // overalls
      ctx.fillStyle = '#FFD700'; ctx.fillRect(x+5*p, y+19*p, p, p); ctx.fillRect(x+8*p, y+19*p, p, p);
      ctx.fillStyle = '#8B4513'; ctx.fillRect(x+2*p, y+24*p, 4*p, 4*p); ctx.fillRect(x+8*p, y+24*p, 4*p, 4*p);
    }
    function drawGoomba(x, y) {
      const p = 2;
      ctx.fillStyle = '#8B4513'; ctx.fillRect(x+2*p, y+6*p, 10*p, 8*p);
      ctx.fillStyle = '#654321'; ctx.fillRect(x+3*p, y+7*p, 8*p, 6*p);
      ctx.fillStyle = '#000'; ctx.fillRect(x+4*p, y+8*p, 2*p, 2*p); ctx.fillRect(x+8*p, y+8*p, 2*p, 2*p);
      ctx.fillStyle = '#FFF'; ctx.fillRect(x+4*p, y+8*p, p, p); ctx.fillRect(x+8*p, y+8*p, p, p);
      ctx.fillStyle = '#000'; ctx.fillRect(x+3*p, y+7*p, 3*p, p); ctx.fillRect(x+8*p, y+7*p, 3*p, p);
      ctx.fillStyle = '#8B4513'; ctx.fillRect(x+1*p, y+13*p, 3*p, 2*p); ctx.fillRect(x+10*p, y+13*p, 3*p, 2*p);
    }

    // --------------- PHYSICS ----------------
    const gravity = 0.8;

    function updatePlayer() {
      if (!gameRunning || levelComplete) return;

      player.velocityX = 0;
      if (keys['a'] || keys['arrowleft']) player.velocityX = -player.speed;
      if (keys['d'] || keys['arrowright']) player.velocityX = player.speed;
      if ((keys[' '] || keys['w'] || keys['arrowup']) && player.onGround) {
        player.velocityY = -player.jumpPower;
        player.onGround = false;
      }

      player.velocityY += gravity;
      player.x += player.velocityX;
      player.y += player.velocityY;
      player.onGround = false;

      platforms.forEach(platform => {
        if (player.x < platform.x + platform.width &&
            player.x + player.width > platform.x &&
            player.y < platform.y + platform.height &&
            player.y + player.height > platform.y) {
          if (player.velocityY > 0 && player.y < platform.y) {
            player.y = platform.y - player.height; player.velocityY = 0; player.onGround = true;
          } else if (player.velocityY < 0 && player.y > platform.y) {
            player.y = platform.y + platform.height; player.velocityY = 0;
          } else if (player.velocityX > 0) {
            player.x = platform.x - player.width;
          } else if (player.velocityX < 0) {
            player.x = platform.x + platform.width;
          }
        }
      });

      questionBlocks.forEach(block => {
        if (block.active &&
            player.x < block.x + block.width &&
            player.x + player.width > block.x &&
            player.y < block.y + block.height &&
            player.y + player.height > block.y) {
          if (player.velocityY < 0 && player.y > block.y) {
            player.y = block.y + block.height; player.velocityY = 0;
            hitQuestionBlock(block);
          } else if (player.velocityY > 0 && player.y < block.y) {
            player.y = block.y - player.height; player.velocityY = 0; player.onGround = true;
          } else if (player.velocityX > 0) {
            player.x = block.x - player.width;
          } else if (player.velocityX < 0) {
            player.x = block.x + block.width;
          }
        }
      });

      if (player.y > canvas.height) gameOver();
      if (player.x < 0) player.x = 0;

      camera.x = player.x - canvas.width / 2;
      if (camera.x < 0) camera.x = 0;
      if (camera.x > 1800 - canvas.width) camera.x = 1800 - canvas.width;
    }

    function updateEnemies() {
      enemies.forEach(enemy => {
        enemy.x += enemy.velocityX;
        if (enemy.x <= enemy.patrolStart || enemy.x >= enemy.patrolEnd) enemy.velocityX *= -1;

        if (player.x < enemy.x + enemy.width &&
            player.x + player.width > enemy.x &&
            player.y < enemy.y + enemy.height &&
            player.y + player.height > enemy.y) {
          if (player.velocityY > 0 && player.y < enemy.y - 10) {
            enemy.x = -1000;
            player.velocityY = -8;
            score += 100;
          } else {
            gameOver();
          }
        }
      });
    }

    function updateCoins() {
      coins.forEach(coin => {
        if (!coin.collected &&
            player.x < coin.x + coin.width &&
            player.x + player.width > coin.x &&
            player.y < coin.y + coin.height &&
            player.y + player.height > coin.y) {
          coin.collected = true;
          score += 50;
        }
      });

      spawnedCoins.forEach((coin, index) => {
        coin.timer--;
        coin.y -= coin.velocityY;
        coin.velocityY -= 0.5;
        if (!coin.collected &&
            player.x < coin.x + coin.width &&
            player.x + player.width > coin.x &&
            player.y < coin.y + coin.height &&
            player.y + player.height > coin.y) {
          coin.collected = true;
          score += 100;
        }
        if (coin.timer <= 0 || coin.collected) spawnedCoins.splice(index, 1);
      });
    }

    function hitQuestionBlock(block) {
      if (!block.active) return;
      block.active = false;
      block.bounceOffset = -8;
      spawnedCoins.push({
        x: block.x + block.width/2 - 7.5,
        y: block.y - 20, width: 15, height: 15,
        timer: 180, velocityY: 8, collected:false
      });
    }

    function updateQuestionBlocks() {
      questionBlocks.forEach(block => {
        if (block.bounceOffset < 0) {
          block.bounceOffset += 0.5;
          if (block.bounceOffset > 0) block.bounceOffset = 0;
        }
      });
    }

    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(-camera.x, -camera.y);

      platforms.forEach(p => {
        ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.width, p.height);
        ctx.fillStyle = p.color === '#FF6347' ? '#DC143C' : '#654321';
        ctx.fillRect(p.x, p.y, p.width, 5);
      });

      enemies.forEach(e => { if (e.x > -1000) drawGoomba(e.x, e.y); });

      coins.forEach(c => {
        if (!c.collected) {
          ctx.fillStyle = '#FFD700'; ctx.beginPath();
          ctx.arc(c.x + c.width/2, c.y + c.height/2, c.width/2, 0, Math.PI*2); ctx.fill();
          ctx.fillStyle = '#FFA500'; ctx.beginPath();
          ctx.arc(c.x + c.width/2, c.y + c.height/2, c.width/4, 0, Math.PI*2); ctx.fill();
        }
      });

      questionBlocks.forEach(b => {
        ctx.fillStyle = b.active ? '#DAA520' : '#8B4513';
        ctx.fillRect(b.x, b.y + b.bounceOffset, b.width, b.height);
        if (b.active) {
          ctx.fillStyle = '#FFFFFF'; ctx.font = '20px Arial'; ctx.textAlign = 'center';
          ctx.fillText('?', b.x + b.width/2, b.y + b.bounceOffset + b.height/2 + 7);
          ctx.strokeStyle = '#B8860B'; ctx.lineWidth = 2; ctx.strokeRect(b.x, b.y + b.bounceOffset, b.width, b.height);
        } else {
          ctx.strokeStyle = '#654321'; ctx.lineWidth = 2; ctx.strokeRect(b.x, b.y + b.bounceOffset, b.width, b.height);
        }
      });

      spawnedCoins.forEach(c => {
        if (!c.collected) {
          ctx.fillStyle = '#FFD700'; ctx.beginPath();
          ctx.arc(c.x + c.width/2, c.y + c.height/2, c.width/2, 0, Math.PI*2); ctx.fill();
          ctx.fillStyle = '#FFA500'; ctx.beginPath();
          ctx.arc(c.x + c.width/2, c.y + c.height/2, c.width/4, 0, Math.PI*2); ctx.fill();
          ctx.fillStyle = '#FFFFFF'; ctx.fillRect(c.x + c.width/2 - 1, c.y + 2, 2, 4);
          ctx.fillRect(c.x + 2, c.y + c.height/2 - 1, 4, 2);
        }
      });

      ctx.fillStyle = goal.color; ctx.fillRect(goal.x, goal.y, goal.width, goal.height);
      ctx.fillStyle = '#FF0000'; ctx.fillRect(goal.x, goal.y, goal.width - 5, 40);
      ctx.fillStyle = '#8B4513'; ctx.fillRect(goal.x + 8, goal.y, 4, goal.height + 20);

      drawMario(player.x, player.y);

      ctx.fillStyle = 'rgba(255,255,255,0.8)';
      for (let i = 0; i < 5; i++) {
        let cloudX = 200 + i * 400;
        ctx.beginPath(); ctx.arc(cloudX, 80, 25, 0, Math.PI * 2);
        ctx.arc(cloudX + 25, 80, 35, 0, Math.PI * 2);
        ctx.arc(cloudX + 50, 80, 25, 0, Math.PI * 2); ctx.fill();
      }

      ctx.restore();

      if (levelComplete && celebrationTimer > 0) {
        ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#FFD700'; ctx.font = 'bold 36px Arial'; ctx.textAlign = 'center';
        if (currentLevel < totalLevels) {
          ctx.fillText('Level Complete!', canvas.width/2, canvas.height/2 - 40);
          ctx.fillStyle = '#FFFFFF'; ctx.font = '24px Arial';
          ctx.fillText(`Bonus: +500 points!`, canvas.width/2, canvas.height/2);
          ctx.fillText(`Get ready for Level ${currentLevel + 1}...`, canvas.width/2, canvas.height/2 + 40);
        } else {
          ctx.fillText('ðŸŽ‰ All Levels Complete! ðŸŽ‰', canvas.width/2, canvas.height/2 - 20);
          ctx.fillStyle = '#FFFFFF'; ctx.font = '24px Arial';
          ctx.fillText(`Final Score: ${score}`, canvas.width/2, canvas.height/2 + 20);
        }
      }

      ctx.fillStyle = '#FFFFFF'; ctx.font = 'bold 20px Arial'; ctx.textAlign = 'left';
      ctx.fillText(`Level: ${currentLevel}/${totalLevels}`, 10, 30);
    }

    // --------------- GAME FLOW ----------------
    function gameOver() {
      if (!gameRunning) return;
      gameRunning = false;

      // stop music immediately on fail
      AudioMgr.stopBg();

      const gameOverDiv = document.createElement('div');
      gameOverDiv.className = 'game-over';
      gameOverDiv.innerHTML = `
        <h2>Game Over!</h2>
        <p>Final Score: ${score}</p>
        <p>Level: ${currentLevel}</p>
        <button onclick="restartGame()">Try Again</button>
      `;
      document.getElementById('gameContainer').appendChild(gameOverDiv);
    }

    function gameWin() {
      if (!gameRunning) return;
      gameRunning = false;
      AudioMgr.stopBg();

      const gameWinDiv = document.createElement('div');
      gameWinDiv.className = 'game-win';
      gameWinDiv.innerHTML = `
        <h2>ðŸŽ‰ You Won! ðŸŽ‰</h2>
        <p>Final Score: ${score}</p>
        <p>All ${totalLevels} levels completed!</p>
        <p>Congratulations, Mario!</p>
        <button onclick="restartGame()">Play Again</button>
      `;
      document.getElementById('gameContainer').appendChild(gameWinDiv);
    }

    function checkGoal() {
      if (player.x < goal.x + goal.width &&
          player.x + player.width > goal.x &&
          player.y < goal.y + goal.height &&
          player.y + player.height > goal.y) {
        if (!levelComplete) {
          levelComplete = true;
          celebrationTimer = 120;
          score += 500;
          AudioMgr.playCelebration();
        }
      }
    }

    function restartGame() {
      document.querySelectorAll('.game-over, .game-win').forEach(o => o.remove());

      // reset state
      score = 0;
      currentLevel = 1;
      levelComplete = false;
      celebrationTimer = 0;
      gameRunning = true;

      loadLevel(currentLevel);

      // if user already granted gesture, resume background track
      if (musicStarted) AudioMgr.startBg();
    }

    function gameLoop() {
      if (levelComplete) {
        celebrationTimer--;
        if (celebrationTimer <= 0) {
          if (currentLevel < totalLevels) {
            currentLevel++;
            levelComplete = false;
            loadLevel(currentLevel);
          } else {
            gameWin();
            return;
          }
        }
      } else {
        updatePlayer();
        updateEnemies();
        updateCoins();
        updateQuestionBlocks();
        checkGoal();
      }

      render();
      scoreElement.textContent = `Score: ${score}`;
      requestAnimationFrame(gameLoop);
    }

    // init
    loadLevel(currentLevel);
    gameLoop();
  </script>
</body>
</html>
